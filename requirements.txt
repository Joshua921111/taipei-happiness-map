import json
import random
import os
from flask import Flask, render_template_string, jsonify, request

# ==========================================
# 1. æ‡‰ç”¨ç¨‹å¼é…ç½®èˆ‡æ¨¡æ“¬æ•¸æ“š (Mock Data Layer)
# ==========================================

app = Flask(__name__)

# æ¨¡æ“¬è‡ºåŒ—å¸‚é–‹æ”¾è³‡æ–™ (OpenData)
# æ ¹æ“š PDF ç¬¬ 4 é å®šç¾©ï¼š
# ç©ºæ°£å“è³ª (PM2.5): æ•¸å€¼ä½ = æ”¾é¬†å€¼é«˜
# ç¶ åœ° (GreenScore): å¯†åº¦é«˜ = ç™‚ç™’å€¼é«˜
# è—æ–‡ (ArtEvents): æ•¸é‡å¤š = æ´»åŠ›å€¼é«˜
# é‹å‹• (SportFacilities): å¯†åº¦é«˜ = èƒ½é‡å€¼é«˜
# å™ªéŸ³ (NoiseLevel): æ•¸å€¼ä½ = å¯§éœå€¼é«˜

LOCATIONS = [
    {
        "id": 1,
        "name": "å¤§å®‰æ£®æ—å…¬åœ’",
        "lat": 25.0300, "lng": 121.5358,
        "description": "åŸå¸‚ä¹‹è‚ºï¼Œå……æ»¿ç¶ æ„èˆ‡å¯§éœã€‚",
        "data": {"pm25": 15, "noise": 45, "green": 95, "art": 2, "sport": 5}
    },
    {
        "id": 2,
        "name": "æ¾å±±æ–‡å‰µåœ’å€",
        "lat": 25.0439, "lng": 121.5606,
        "description": "å……æ»¿æ–‡è—æ°£æ¯èˆ‡å±•è¦½çš„å‰µæ„åŸºåœ°ã€‚",
        "data": {"pm25": 20, "noise": 60, "green": 40, "art": 90, "sport": 1}
    },
    {
        "id": 3,
        "name": "è±¡å±±è¦ªå±±æ­¥é“",
        "lat": 25.0273, "lng": 121.5707,
        "description": "é çœºå°åŒ—101ï¼Œæ®ç‘æ±—æ°´çš„çµ•ä½³åœ°é»ã€‚",
        "data": {"pm25": 10, "noise": 35, "green": 85, "art": 0, "sport": 80}
    },
    {
        "id": 4,
        "name": "è¥¿é–€ç”ºç´…æ¨“",
        "lat": 25.0423, "lng": 121.5061,
        "description": "ç†±é¬§å–§å›‚ï¼Œå……æ»¿å¹´è¼•æ´»åŠ›çš„èšé›†åœ°ã€‚",
        "data": {"pm25": 35, "noise": 85, "green": 10, "art": 60, "sport": 10}
    },
    {
        "id": 5,
        "name": "åŒ—æŠ•åœ–æ›¸é¤¨",
        "lat": 25.1363, "lng": 121.5063,
        "description": "ä¸–ç•Œæœ€ç¾åœ–æ›¸é¤¨ä¹‹ä¸€ï¼Œæ›¸é¦™èˆ‡æº«æ³‰çš„çµåˆã€‚",
        "data": {"pm25": 8, "noise": 30, "green": 90, "art": 30, "sport": 0}
    },
    {
        "id": 6,
        "name": "å°åŒ—ç”°å¾‘å ´",
        "lat": 25.0489, "lng": 121.5517,
        "description": "å°ˆæ¥­é‹å‹•å ´åœ°ï¼Œé‡‹æ”¾å£“åŠ›çš„å¥½å»è™•ã€‚",
        "data": {"pm25": 25, "noise": 65, "green": 30, "art": 5, "sport": 95}
    },
    {
        "id": 7,
        "name": "è¯å±±1914æ–‡å‰µåœ’å€",
        "lat": 25.0441, "lng": 121.5293,
        "description": "èˆŠé…’å» æ”¹å»ºçš„è—æ–‡ä¸­å¿ƒï¼Œé€±æœ«çš„å¥½å»è™•ã€‚",
        "data": {"pm25": 22, "noise": 55, "green": 50, "art": 85, "sport": 5}
    },
    {
        "id": 8,
        "name": "æ¤ç‰©åœ’",
        "lat": 25.0333, "lng": 121.5096,
        "description": "æ­·å²æ‚ ä¹…çš„æ¤ç‰©åœ’ï¼Œæ“æœ‰è±å¯Œçš„ç”Ÿæ…‹ã€‚",
        "data": {"pm25": 12, "noise": 40, "green": 92, "art": 10, "sport": 20}
    }
]

# ç”¨æˆ¶ç©åˆ† (æ¨¡æ“¬ Gamification)
# æ³¨æ„ï¼šåœ¨çœŸå¯¦éƒ¨ç½²ä¸­ï¼Œé€™è£¡æ‡‰è©²é€£æ¥è³‡æ–™åº« (å¦‚ Firestore æˆ– PostgreSQL)
# å› ç‚º Render å…è²»ç‰ˆé‡å•Ÿå¾Œï¼Œè¨˜æ†¶é«”è®Šæ•¸æœƒé‡ç½®ã€‚ä½†ä½œç‚º Demo è¶³å¤ äº†ã€‚
user_points = 0

# ==========================================
# 2. æ ¸å¿ƒé‚è¼¯å±¤ (Business Logic)
# ==========================================

def calculate_happiness_indices(loc_data):
    """
    æ ¸å¿ƒæ¼”ç®—æ³•ï¼šå°‡ç’°å¢ƒæ•¸æ“šè½‰æ›ç‚ºå¹¸ç¦æŒ‡æ¨™
    """
    # æ”¾é¬†å€¼: ç©ºæ°£å¥½ + å®‰éœ
    pm25_score = max(0, 100 - loc_data['pm25'] * 2)
    noise_score = max(0, 100 - loc_data['noise'] * 1.2)
    relaxation = (pm25_score + noise_score) / 2

    # ç™‚ç™’å€¼: ç¶ åœ°å¤š
    healing = loc_data['green']

    # æ´»åŠ›å€¼: è—æ–‡ + é©åº¦ç†±é¬§
    vitality = min(100, (loc_data['art'] + loc_data['sport'] * 0.8))

    # èƒ½é‡å€¼: é‹å‹•è¨­æ–½
    energy = loc_data['sport']

    return {
        "relaxation": round(relaxation, 1),
        "healing": round(healing, 1),
        "vitality": round(vitality, 1),
        "energy": round(energy, 1)
    }

# ==========================================
# 3. è¦–åœ–èˆ‡è·¯ç”± (Views & Routes)
# ==========================================

@app.route('/')
def index():
    """æ¸²æŸ“ä¸»é é¢ (SPAçµæ§‹)"""
    return render_template_string(HTML_TEMPLATE)

@app.route('/api/locations', methods=['GET'])
def get_locations():
    """API: å›å‚³è¨ˆç®—éå¹¸ç¦æŒ‡æ•¸çš„åœ°é»è³‡æ–™"""
    mood = request.args.get('mood', 'all')
    
    processed_locations = []
    
    for loc in LOCATIONS:
        indices = calculate_happiness_indices(loc['data'])
        
        # æ±ºå®šä¸»è¦æ¨è–¦åˆ†æ•¸èˆ‡æ¨™ç±¤
        match_score = 0
        tag = ""
        
        if mood == 'relax': # æ”¾é¬† (æ‰¾æ”¾é¬†å€¼é«˜çš„)
            match_score = indices['relaxation']
            tag = "â˜ï¸ æ¥µè‡´æ”¾é¬†"
        elif mood == 'heal': # ç™‚ç™’ (æ‰¾ç¶ åœ°å¤šçš„)
            match_score = indices['healing']
            tag = "ğŸŸŸ è‡ªç„¶ç™‚ç™’"
        elif mood == 'vitality': # æ´»åŠ› (æ‰¾ç†±é¬§çš„)
            match_score = indices['vitality']
            tag = "ğŸŸŸ è—æ–‡æ´»åŠ›"
        elif mood == 'sport': # é‹å‹• (æ‰¾èƒ½é‡é«˜çš„)
            match_score = indices['energy']
            tag = "ğŸŸŸâ€â™‚ï¸ æ®ç‘æ±—æ°´"
        else:
            # ç¶œåˆå¹³å‡
            match_score = (indices['relaxation'] + indices['healing'] + indices['vitality']) / 3
            tag = "ğŸŸŸ ç¶œåˆæ¨è–¦"

        loc_obj = loc.copy()
        loc_obj['indices'] = indices
        loc_obj['match_score'] = round(match_score, 1)
        loc_obj['tag'] = tag
        processed_locations.append(loc_obj)

    # æ’åºï¼šåˆ†æ•¸é«˜çš„åœ¨å‰
    processed_locations.sort(key=lambda x: x['match_score'], reverse=True)
    
    return jsonify(processed_locations)

@app.route('/api/checkin', methods=['POST'])
def checkin():
    """API: æ¨¡æ“¬éŸ¿éˆ´ä»»å‹™æ‰“å¡"""
    global user_points
    data = request.json
    points_earned = random.randint(10, 50)
    user_points += points_earned
    
    return jsonify({
        "status": "success",
        "message": f"æ‰“å¡æˆåŠŸï¼æ¢ç´¢ã€Œ{data.get('locationName')}ã€ä»»å‹™å®Œæˆã€‚",
        "earned": points_earned,
        "total_points": user_points
    })

# ==========================================
# 4. å‰ç«¯æ¨¡æ¿ (Frontend Template)
# ä½¿ç”¨ TailwindCSS + Leaflet.js
# ==========================================

HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‡ºåŒ—å¸‚å¹¸ç¦éˆ´ | åŸå¸‚å¹¸ç¦åœ°åœ–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .mood-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .card-animate { transition: all 0.3s ease; }
        .card-animate:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        /* Mobile Layout Optimizations */
        .mobile-panel { max-height: 45vh; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-md z-50 px-4 py-3 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-bell text-yellow-500 text-xl"></i>
            <h1 class="text-lg font-bold text-gray-800">å¹¸ç¦åœ°åœ–</h1>
        </div>
        <div class="flex items-center gap-2 bg-yellow-100 px-3 py-1 rounded-full">
            <i class="fa-solid fa-medal text-yellow-600"></i>
            <span id="user-points" class="font-bold text-yellow-700">0</span>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex flex-1 flex-col md:flex-row overflow-hidden relative">
        
        <!-- Mobile: Map is background, Panel is overlay/bottom sheet -->
        <!-- Desktop: Side by side -->
        
        <!-- Sidebar / Control Panel -->
        <div class="order-2 md:order-1 w-full md:w-1/3 bg-white shadow-lg flex flex-col z-20 mobile-panel md:h-full rounded-t-xl md:rounded-none overflow-hidden absolute bottom-0 md:relative md:bottom-auto h-[45vh] md:h-auto">
            
            <!-- Mood Selector -->
            <div class="p-3 border-b bg-white shrink-0">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-2 md:hidden"></div>
                <h2 class="text-gray-500 text-xs mb-2 font-bold uppercase tracking-wider">ä»Šæ—¥å¿ƒæƒ…</h2>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="changeMood('relax')" class="mood-btn border border-gray-200 text-gray-600 p-2 rounded-lg text-xs flex flex-col items-center gap-1 hover:bg-blue-50">
                        <i class="fa-solid fa-cloud text-lg"></i> æ”¾é¬†
                    </button>
                    <button onclick="changeMood('heal')" class="mood-btn border border-gray-200 text-gray-600 p-2 rounded-lg text-xs flex flex-col items-center gap-1 hover:bg-green-50">
                        <i class="fa-solid fa-tree text-lg"></i> ç™‚ç™’
                    </button>
                    <button onclick="changeMood('vitality')" class="mood-btn border border-gray-200 text-gray-600 p-2 rounded-lg text-xs flex flex-col items-center gap-1 hover:bg-purple-50">
                        <i class="fa-solid fa-palette text-lg"></i> æ´»åŠ›
                    </button>
                    <button onclick="changeMood('sport')" class="mood-btn border border-gray-200 text-gray-600 p-2 rounded-lg text-xs flex flex-col items-center gap-1 hover:bg-red-50">
                        <i class="fa-solid fa-running text-lg"></i> ç™¼æ´©
                    </button>
                </div>
            </div>

            <!-- Recommendations List -->
            <div class="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-50" id="location-list">
                <div class="text-center text-gray-400 mt-10">
                    <i class="fa-solid fa-spinner fa-spin text-2xl"></i><br>
                    æ­£åœ¨è¨ˆç®—å¹¸ç¦æŒ‡æ•¸...
                </div>
            </div>
        </div>

        <!-- Map Area -->
        <div class="order-1 md:order-2 w-full h-[55vh] md:h-full md:w-2/3 relative">
            <div id="map"></div>
            
            <!-- Legend -->
            <div class="absolute top-4 right-4 bg-white/90 p-2 rounded shadow z-[1000] text-xs backdrop-blur-sm hidden md:block">
                <div class="font-bold mb-1">OpenData ä¾†æº</div>
                <div class="flex items-center gap-1"><div class="w-2 h-2 bg-green-500 rounded-full"></div> ç’°ä¿å±€</div>
                <div class="flex items-center gap-1"><div class="w-2 h-2 bg-blue-500 rounded-full"></div> å…¬åœ’è™•</div>
            </div>
        </div>
    </div>

    <!-- Check-in Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[2000] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center animate-bounce-in">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-trophy text-yellow-500 text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">ä»»å‹™é”æˆï¼</h3>
            <p id="modal-text" class="text-gray-600 mb-6">æ‚¨å·²æ¢ç´¢è©²åœ°é»</p>
            <button onclick="closeModal()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-bold shadow-lg">
                é ˜å–ç©åˆ† (+<span id="modal-points"></span>)
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let markers = [];
        let currentLocations = [];

        function initMap() {
            // å°åŒ—å¸‚ä¸­å¿ƒ
            map = L.map('map', { zoomControl: false }).setView([25.04, 121.55], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: 'OpenStreetMap'
            }).addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);
            fetchLocations('all');
        }

        async function fetchLocations(mood) {
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-50', 'bg-green-50', 'bg-purple-50', 'bg-red-50'));
            
            // Highlight active button (logic simplified for brevity)
            const map = {'relax':0, 'heal':1, 'vitality':2, 'sport':3};
            if(map[mood] !== undefined) {
                const btn = document.querySelectorAll('.mood-btn')[map[mood]];
                btn.classList.add('active');
            }

            const res = await fetch(`/api/locations?mood=${mood}`);
            currentLocations = await res.json();
            updateUI();
        }

        function updateUI() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const list = document.getElementById('location-list');
            list.innerHTML = '';

            currentLocations.forEach(loc => {
                // Map Marker
                const marker = L.marker([loc.lat, loc.lng]).addTo(map)
                    .bindPopup(`
                        <div class="text-center">
                            <b class="text-lg">${loc.name}</b><br>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded">${loc.tag}</span>
                            <button onclick="checkIn('${loc.name}')" class="mt-2 bg-blue-500 text-white text-xs px-4 py-1 rounded-full block mx-auto">æ‰“å¡</button>
                        </div>
                    `);
                markers.push(marker);

                // List Card
                const item = document.createElement('div');
                item.className = "bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex flex-col gap-2 cursor-pointer active:scale-95 transition-transform";
                item.onclick = () => {
                    map.flyTo([loc.lat, loc.lng], 16);
                    marker.openPopup();
                };
                
                // Color logic based on match score
                let scoreColor = loc.match_score > 80 ? 'text-green-600' : 'text-blue-600';

                item.innerHTML = `
                    <div class="flex justify-between">
                        <h4 class="font-bold text-gray-800">${loc.name}</h4>
                        <span class="text-xs font-bold ${scoreColor}">${loc.match_score}% åŒ¹é…</span>
                    </div>
                    <p class="text-xs text-gray-500 line-clamp-1">${loc.description}</p>
                    <div class="flex gap-2 mt-1">
                        <span class="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-500">${loc.tag}</span>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        async function checkIn(name) {
            try {
                const res = await fetch('/api/checkin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ locationName: name })
                });
                const data = await res.json();
                document.getElementById('user-points').innerText = data.total_points;
                document.getElementById('modal-points').innerText = data.earned;
                document.getElementById('modal-text').innerText = data.message;
                document.getElementById('modal').classList.remove('hidden');
            } catch(e) { console.error(e); }
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        window.onload = initMap;
    </script>
</body>
</html>
"""

if __name__ == '__main__':
    port = int(os.environ.get("PORT", 5000))
    app.run(host='0.0.0.0', port=port)


flask
gunicorn
